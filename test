<?php

    require_once('tcpdf/config/lang/eng.php');
    require_once('tcpdf/tcpdf.php');

    class TCPDF_Rotate extends TCPDF {
        function RotatedText($x,$y,$txt,$angle) {
            //Text rotated around its origin
            //$this->SetXY($x,$y);
            $this->StartTransform();
            $this->Rotate($angle,$x,$y);
            $this->Text($x,$y,$txt);
            $this->StopTransform();
            //$this->Rotate(-$angle);
        }

        function RotatedMultiText($x,$y,$txt,$angle) {
            //Text rotated around its origin
            $this->SetXY($x,$y);
            $this->StartTransform();
            $this->Rotate($angle,$x,$y);
            $this->MultiCell((205-$y), 4, $txt);
            $this->StopTransform();
            //$this->Rotate(-$angle);
        }

        function RotatedImage($file,$x,$y,$w,$h,$angle) {
            //Image rotated around its upper-left corner
            $this->Rotate($angle,$x,$y);
            $this->Image($file,$x,$y,$w,$h);
            $this->Rotate(-$angle);
        }
        
    }

    $pdf=new TCPDF_Rotate('L', 'mm', 'A4', true, 'UTF-8', false);
    $pdf->SetTitle((osc_item_title()));
    $pdf->SetAuthor(osc_page_title());
    
    $bottom_y = 140;

    
    // CREATE PAGE
    $pdf->addPage('L','A4');

    // HEADER
	$customField =  osc_get_preference('Custom', 'printpdf');
	$customFieldtwo = osc_get_preference('Custom_two', 'printpdf');
	$customFieldthree = osc_get_preference('Custom_three', 'printpdf');
	$customFieldfour = osc_get_preference('Custom_four', 'printpdf');
	
	if ($customField == '') { $customName =  $customField ; } else { $customName =  $customField .(': ');}
	
	if ($customFieldtwo == '') { $customNametwo =  $customFieldtwo ; } else { $customNametwo =  $customFieldtwo .(': ');}
	
	if ($customFieldthree == '') { $customNamethree =  $customFieldthree ; } else { $customNamethree =  $customFieldthree .(': ');}
	
	if ($customFieldfour == '') { $customNamefour =  $customFieldfour ; } else { $customNamefour =  $customFieldfour .(': ');}
	
	$shortenedurl = file_get_contents('http://short.swappingol.com/shorten.php?longurl=' .osc_item_url());
	
	 $email_array = array();
       if(osc_item_show_email()) { $email_array[] = osc_item_contact_email() ; }
         $email = utf8_decode(html_entity_decode(implode($email_array)));
   
    $custom_array = array();
      if( osc_count_item_meta() >= 1 ) { 
      while ( osc_has_item_meta() ) { 
 if(osc_item_meta_name() == $customField) { 
     $custom_array[] = osc_item_meta_value(); }
	 if(osc_item_meta_name() == $customFieldtwo) { 
     $customtwo_array[] = osc_item_meta_value(); }
	if(osc_item_meta_name() == $customFieldthree) { 
     $customthree_array[] = osc_item_meta_value(); } 
	 if(osc_item_meta_name() == $customFieldfour) { 
     $customfour_array[] = osc_item_meta_value(); }}}
         $custom = utf8_decode(html_entity_decode(implode(", ", $custom_array))); 
		 $customthree = utf8_decode(html_entity_decode(implode(", ", $customthree_array))); 
		 $customfour = utf8_decode(html_entity_decode(implode(", ", $customfour_array)));
		 $acustomtwo = utf8_decode(html_entity_decode(implode(", ",  $customtwo_array )));
		 $customtwo = osc_highlight( strip_tags( $acustomtwo ), 420 ) ;
		 
		
         
		 
		 $atitle = osc_highlight( strtoupper( osc_item_title() ),70);
		 
		 $title = osc_highlight( strtoupper( osc_item_title() ),30);
		 
		  $atext = osc_item_description() ;
		 $btext = html_entity_decode( $atext , ENT_NOQUOTES ,  "UTF-8");
		 $descrption = osc_highlight( strip_tags( $btext ), 610 ) ;
    
    $pdf->Image('logo.png', 175, 15, 120, 25);
    
    $x = 10;
    $pdf->SetXY($x,5);
    $pdf->SetFillColor(255,255,255);
    $pdf->SetTextColor(000,0,60); // TITLE COLOR
    $pdf->SetFont('helvetica','B',18);
    $pdf->Cell(0,9,('').$atitle,'',1,'L', false);
    $pdf->SetTextColor(0,0,0); // BLACK COLOR
        // Contact information
        $pdf->SetFont('helvetica','B',10);
        $pdf->setXY(115,40);
        $pdf->Cell(0,10,  sprintf(__('Contatto: %s', 'printpdf'), osc_item_contact_name()),'',1,'L', false);
         
        // QR-CODE
        $y = $pdf->GetY();
        $pdf->write2DBarcode($shortenedurl, 'QRCODE,L', 300 - 30 -30, 40, 30, 30);
        $pdf->setXY(115,50);
        $pdf->Cell(0,1,  ('E-mail: ').$email,'',1,'L', false);
        $pdf->setX(115);
        $pdf->Cell(0,1,  $customName .$custom,'',1,'L', false);
		$pdf->setX(115);
        $pdf->Cell(0,1,  $customNamethree .$customthree,'',1,'L', false);
		$pdf->setX(115);
        $pdf->Cell(0,1,  $customNamefour .$customfour,'',1,'L', false);
        $pdf->setXY(230,75);
        $pdf->Cell(0,1,  $shortenedurl,'',1,'L', false);
		$pdf->setXY(115,78);
        $pdf->Cell(0,1,  ('Descrizione: '),'',1,'L', false);
		
       
    
    // CONTENT - DESCRIPTION
    if(osc_has_item_resources()) {
        $y = 50;
        $x = 20;
        $width = 110;
        $height = $bottom_y-$y-15;
        
        $data = getimagesize(osc_resource_url());
        $w = $data[0];
        $h = $data[1];

        if(($w/$h)>=($width/$height)) {
            $newW = ($w > $width)? $width : $w;
            $newH = $h * ($newW / $w);
        } else {
            $newH = ($h > $height)? $height : $h;
            $newW = $w * ($newH / $h);
        }
        
        $pdf->Image(osc_resource_url(), 5 + (($width-$newW)/2), 40 + (($height-$newH)/2), $newW, $newH);
        $x = 140;
    } else {
        $x = 20;
    }

    $pdf->Ln();
        // ADDRES AND PRICE
        $address_array = array();
        if ( osc_item_address() != "" ) { $address_array[] = osc_item_address() ; }
        if ( osc_item_city_area() != "" ) { $address_array[] = osc_item_city_area() ; }
        if ( osc_item_city() != "" ) { $address_array[] = osc_item_city() ; }
        
        $address = implode(", ", $address_array);
        
        $pdf->SetFont('helvetica','',10);
        $pdf->setXY(115,70);
        $pdf->Cell(0,4,  __('Indirizzo: ', 'printpdf'),'',0,'L', false);
        $pdf->SetFont('helvetica','B',10);
        $pdf->setX(130);
        $pdf->Cell(0,4,  $address,'',0,'L', false);
        $pdf->Ln();
       /* $pdf->SetFont('helvetica','',10);
        $pdf->setX(115);
        $pdf->Cell(0,4,  __('Price: ', 'printpdf'),'',0,'L', false); 
        $pdf->SetFont('helvetica','B',10);
        $pdf->setX(130);
        $pdf->Cell(0,4,  osc_item_formated_price(),'',0,'L', false);*/
        $pdf->Ln();
    // DESCRIPTION
    $pdf->Ln();
    $pdf->SetFont('helvetica','',10);
    $pdf->setX(115);
    $y = $pdf->GetY();
    
    $pdf->MultiCell(0,4,('').$descrption,0,'L', false, 0, 115, $y, true, 0, false, true, 80);
    //$pdf->writeHTMLCell(0,4, $x, $y,"<div style=\"height:100px\">".osc_item_description()."</div>",0,'L', false, 100);
	$pdf->SetFont('helvetica','B');
	$pdf->MultiCell(0,4,('').$customNametwo,0,'L', false, 0, 115, $y+30, true, 0, false, true, 80);
	$pdf->SetFont();
    $pdf->MultiCell(0,4,('').$customtwo,0,'L', false, 0, 115, $y+35, true, 0, false, true, 80);
    
    
    
    
    // DE-ATTACHABLE TAGS
    $x = 0;
    $y = $bottom_y;
    $pdf->Line($x, $y, 300, $y);
    for($i = 0;$i<10;$i++) {
		
		$contactName = osc_item_contact_name();
        // Title
		$pdf->SetFont('pdfatimesb','B',10);
		$pdf->SetTextColor(33,99,33);
		$pdf->RotatedText($x + (29.5*$i) + 29 , $y+2, osc_base_url(),270);
		$pdf->SetFont('helvetica','B',9);
        $pdf->SetTextColor(000,0,60); // TITLE COLOR
        $pdf->RotatedText($x + (29.5*$i) + 24 , $y+2,('').$title,270);
        // Contact
        $pdf->SetFont('helvetica','B',8);
        $pdf->SetTextColor(0,0,0); // BLACK COLOR
        $pdf->RotatedText($x + (29.5*$i) + 20 , $y+2, ('Contatto: ').$contactName, 270);
        // Email
		$pdf->RotatedText($x + (29.5*$i) + 16 , $y+2, ('Email: ').$email, 270);
        $pdf->RotatedText($x + (29.5*$i) + 12 , $y+2, $customName .$custom, 270);
		$pdf->RotatedText($x + (29.5*$i) + 8 , $y+2, $customNamethree .$customthree, 270);
        // URL
        $pdf->SetTextColor(0,0,155); // BLUE COLOR
        $short_url = $shortenedurl;
        $pdf->RotatedMultiText($x + (29.5*$i) + 4 , $y+2, ($short_url), 270);
        if($i!=9) {
            $pdf->Line((29.5*($i+1)), $bottom_y, (29.5*($i+1)), 270);
        }
        $pdf->SetTextColor(0,0,0); // BLACK COLOR
 
    }
    
    


    $pdf->Output($path, 'F');

?>
